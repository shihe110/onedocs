<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>IOC原理 | 毫末之木</title>
    <meta name="generator" content="VuePress 1.5.2">
    <link rel="icon" href="/onedocs/logo.png">
    <meta name="description" content="合抱之木生于毫末，九层之台起于累土，千里之行始于足下">
    <link rel="preload" href="/onedocs/assets/css/0.styles.de272f6a.css" as="style"><link rel="preload" href="/onedocs/assets/js/app.11121a75.js" as="script"><link rel="preload" href="/onedocs/assets/js/2.2038ef08.js" as="script"><link rel="preload" href="/onedocs/assets/js/27.8aa415f6.js" as="script"><link rel="prefetch" href="/onedocs/assets/js/10.8bf566d4.js"><link rel="prefetch" href="/onedocs/assets/js/11.73eae290.js"><link rel="prefetch" href="/onedocs/assets/js/12.fd605992.js"><link rel="prefetch" href="/onedocs/assets/js/13.58012642.js"><link rel="prefetch" href="/onedocs/assets/js/14.c44708b8.js"><link rel="prefetch" href="/onedocs/assets/js/15.56235085.js"><link rel="prefetch" href="/onedocs/assets/js/16.7d04c950.js"><link rel="prefetch" href="/onedocs/assets/js/17.18985c21.js"><link rel="prefetch" href="/onedocs/assets/js/18.425b7c2e.js"><link rel="prefetch" href="/onedocs/assets/js/19.223fba8b.js"><link rel="prefetch" href="/onedocs/assets/js/20.410bacb0.js"><link rel="prefetch" href="/onedocs/assets/js/21.5829f511.js"><link rel="prefetch" href="/onedocs/assets/js/22.a1b27cf1.js"><link rel="prefetch" href="/onedocs/assets/js/23.9f1f9f0b.js"><link rel="prefetch" href="/onedocs/assets/js/24.043fc1e3.js"><link rel="prefetch" href="/onedocs/assets/js/25.6fdf08d7.js"><link rel="prefetch" href="/onedocs/assets/js/26.22a2f5e2.js"><link rel="prefetch" href="/onedocs/assets/js/28.c46d22b1.js"><link rel="prefetch" href="/onedocs/assets/js/29.bb72deae.js"><link rel="prefetch" href="/onedocs/assets/js/3.c7ea1863.js"><link rel="prefetch" href="/onedocs/assets/js/30.9f7f293a.js"><link rel="prefetch" href="/onedocs/assets/js/31.7c420962.js"><link rel="prefetch" href="/onedocs/assets/js/32.8c9649a0.js"><link rel="prefetch" href="/onedocs/assets/js/33.29df0e69.js"><link rel="prefetch" href="/onedocs/assets/js/34.a990bd7e.js"><link rel="prefetch" href="/onedocs/assets/js/35.0a96d856.js"><link rel="prefetch" href="/onedocs/assets/js/36.9e7ce57e.js"><link rel="prefetch" href="/onedocs/assets/js/37.29b89d8c.js"><link rel="prefetch" href="/onedocs/assets/js/38.aaacceb0.js"><link rel="prefetch" href="/onedocs/assets/js/39.67d2429c.js"><link rel="prefetch" href="/onedocs/assets/js/4.7d5f245c.js"><link rel="prefetch" href="/onedocs/assets/js/40.e1707e98.js"><link rel="prefetch" href="/onedocs/assets/js/41.f14682e9.js"><link rel="prefetch" href="/onedocs/assets/js/42.21794e9c.js"><link rel="prefetch" href="/onedocs/assets/js/43.92fae496.js"><link rel="prefetch" href="/onedocs/assets/js/44.066af7ce.js"><link rel="prefetch" href="/onedocs/assets/js/45.92cc22eb.js"><link rel="prefetch" href="/onedocs/assets/js/46.5f38fd8b.js"><link rel="prefetch" href="/onedocs/assets/js/47.449d0429.js"><link rel="prefetch" href="/onedocs/assets/js/48.19af4dd1.js"><link rel="prefetch" href="/onedocs/assets/js/49.6ebe7e7e.js"><link rel="prefetch" href="/onedocs/assets/js/5.94238f35.js"><link rel="prefetch" href="/onedocs/assets/js/50.e3ace8b9.js"><link rel="prefetch" href="/onedocs/assets/js/51.cd0b1e37.js"><link rel="prefetch" href="/onedocs/assets/js/52.ed912303.js"><link rel="prefetch" href="/onedocs/assets/js/53.5ad145ab.js"><link rel="prefetch" href="/onedocs/assets/js/54.c26ea06f.js"><link rel="prefetch" href="/onedocs/assets/js/55.f5e25528.js"><link rel="prefetch" href="/onedocs/assets/js/56.90e69094.js"><link rel="prefetch" href="/onedocs/assets/js/57.5a6835de.js"><link rel="prefetch" href="/onedocs/assets/js/58.73b9efe9.js"><link rel="prefetch" href="/onedocs/assets/js/59.2343fd72.js"><link rel="prefetch" href="/onedocs/assets/js/6.4cfe444e.js"><link rel="prefetch" href="/onedocs/assets/js/60.06cec522.js"><link rel="prefetch" href="/onedocs/assets/js/61.9fb06261.js"><link rel="prefetch" href="/onedocs/assets/js/62.a10e8dbe.js"><link rel="prefetch" href="/onedocs/assets/js/63.328be519.js"><link rel="prefetch" href="/onedocs/assets/js/7.80046a6e.js"><link rel="prefetch" href="/onedocs/assets/js/8.781e07a6.js"><link rel="prefetch" href="/onedocs/assets/js/9.a886f15e.js">
    <link rel="stylesheet" href="/onedocs/assets/css/0.styles.de272f6a.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/onedocs/" class="home-link router-link-active"><img src="/onedocs/logo.png" alt="毫末之木" class="logo"> <span class="site-name can-hide">毫末之木</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/onedocs/" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><span class="title">Java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/onedocs/JavaApi/" class="nav-link">
  javaApi
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Spring系列" class="dropdown-title"><span class="title">Spring系列</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/onedocs/Spring/" class="nav-link router-link-active">
  spring
</a></li><li class="dropdown-item"><!----> <a href="/onedocs/SpringMVC/" class="nav-link">
  spring-mvc
</a></li><li class="dropdown-item"><!----> <a href="/onedocs/SpringBoot/" class="nav-link">
  spring-boot
</a></li><li class="dropdown-item"><!----> <a href="/onedocs/SpringCloud/" class="nav-link">
  spring-cloud
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Database" class="dropdown-title"><span class="title">Database</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/onedocs/sql/" class="nav-link">
  Oracle
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Vue" class="dropdown-title"><span class="title">Vue</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/onedocs/vue/" class="nav-link">
  vue
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="工具集" class="dropdown-title"><span class="title">工具集</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/onedocs/web/" class="nav-link">
  web
</a></li><li class="dropdown-item"><!----> <a href="/onedocs/maven/" class="nav-link">
  maven
</a></li><li class="dropdown-item"><!----> <a href="/onedocs/github/" class="nav-link">
  github
</a></li><li class="dropdown-item"><!----> <a href="/onedocs/browser/" class="nav-link">
  browser
</a></li><li class="dropdown-item"><!----> <a href="/onedocs/idea/" class="nav-link">
  idea
</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/shihe110" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/onedocs/" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><span class="title">Java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/onedocs/JavaApi/" class="nav-link">
  javaApi
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Spring系列" class="dropdown-title"><span class="title">Spring系列</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/onedocs/Spring/" class="nav-link router-link-active">
  spring
</a></li><li class="dropdown-item"><!----> <a href="/onedocs/SpringMVC/" class="nav-link">
  spring-mvc
</a></li><li class="dropdown-item"><!----> <a href="/onedocs/SpringBoot/" class="nav-link">
  spring-boot
</a></li><li class="dropdown-item"><!----> <a href="/onedocs/SpringCloud/" class="nav-link">
  spring-cloud
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Database" class="dropdown-title"><span class="title">Database</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/onedocs/sql/" class="nav-link">
  Oracle
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Vue" class="dropdown-title"><span class="title">Vue</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/onedocs/vue/" class="nav-link">
  vue
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="工具集" class="dropdown-title"><span class="title">工具集</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/onedocs/web/" class="nav-link">
  web
</a></li><li class="dropdown-item"><!----> <a href="/onedocs/maven/" class="nav-link">
  maven
</a></li><li class="dropdown-item"><!----> <a href="/onedocs/github/" class="nav-link">
  github
</a></li><li class="dropdown-item"><!----> <a href="/onedocs/browser/" class="nav-link">
  browser
</a></li><li class="dropdown-item"><!----> <a href="/onedocs/idea/" class="nav-link">
  idea
</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/shihe110" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Spring</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/onedocs/Spring/IOC.html" aria-current="page" class="active sidebar-link">IOC原理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/onedocs/Spring/IOC.html#ioc原理" class="sidebar-link">IOC原理</a></li><li class="sidebar-sub-header"><a href="/onedocs/Spring/IOC.html#装备bean（容器中bean的装配方式-xml、annotation）" class="sidebar-link">装备bean（容器中bean的装配方式-xml、annotation）</a></li><li class="sidebar-sub-header"><a href="/onedocs/Spring/IOC.html#容器装配-annotation配置" class="sidebar-link">容器装配-annotation配置</a></li><li class="sidebar-sub-header"><a href="/onedocs/Spring/IOC.html#bean-scope" class="sidebar-link">bean scope</a></li><li class="sidebar-sub-header"><a href="/onedocs/Spring/IOC.html#resource-封装了读取配置文件或加载资源文件" class="sidebar-link">Resource - 封装了读取配置文件或加载资源文件</a></li><li class="sidebar-sub-header"><a href="/onedocs/Spring/IOC.html#配置注入" class="sidebar-link">配置注入</a></li><li class="sidebar-sub-header"><a href="/onedocs/Spring/IOC.html#条件装配（springboot灵魂）" class="sidebar-link">条件装配（springboot灵魂）</a></li></ul></li><li><a href="/onedocs/Spring/" aria-current="page" class="sidebar-link">首页</a></li><li><a href="/onedocs/Spring/Spring-AOP.html" class="sidebar-link">Spring-AOP</a></li><li><a href="/onedocs/Spring/Spring中的Aware.html" class="sidebar-link">Spring中的Aware</a></li><li><a href="/onedocs/Spring/Spring事件.html" class="sidebar-link">Spring事件 Application Event</a></li><li><a href="/onedocs/Spring/Spring动态代理.html" class="sidebar-link">Spring静态代理</a></li><li><a href="/onedocs/Spring/Spring基础之1简史.html" class="sidebar-link">Spring概述</a></li><li><a href="/onedocs/Spring/Spring常用配置.html" class="sidebar-link">Spring高频配置</a></li><li><a href="/onedocs/Spring/Spring注解Enable.html" class="sidebar-link">@Enable*注解的工作原理</a></li><li><a href="/onedocs/Spring/Spring注解注入组件扫描.html" class="sidebar-link">spring中注解注入context:component-scan使用总结</a></li><li><a href="/onedocs/Spring/spring配置文件加载.html" class="sidebar-link">Spring配置文件加载</a></li><li><a href="/onedocs/Spring/ssm启动过程web.xml配置详解.html" class="sidebar-link">本篇主要在基于SSM的框架，深入讲解web.xml的配置</a></li><li><a href="/onedocs/Spring/拦截器和过滤器使用场景及区别.html" class="sidebar-link">拦截器和过滤器的区别总结</a></li><li><a href="/onedocs/Spring/获取applicationContext的几种方式.html" class="sidebar-link">获取容器ApplicationContext的几种方式</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="ioc原理"><a href="#ioc原理" class="header-anchor">#</a> IOC原理</h2> <p>IoC又称为依赖注入（DI：Dependency Injection），它解决了一个最主要的问题：将组件的创建+配置与组件的使用相分离，并且，由IoC容器负责管理组件的生命周期。</p> <p>因为IoC容器要负责实例化所有的组件，因此，有必要告诉容器如何创建组件，以及各组件的依赖关系。一种最简单的配置是通过XML文件来实现，例如：</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>beans</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>dataSource<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>HikariDataSource<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>bookService<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>BookService<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>dataSource<span class="token punctuation">&quot;</span></span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>dataSource<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>userService<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>UserService<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>dataSource<span class="token punctuation">&quot;</span></span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>dataSource<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>beans</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>上述XML配置文件指示IoC容器创建3个JavaBean组件，并把id为dataSource的组件通过属性dataSource（即调用setDataSource()方法）注入到另外两个组件中。</p> <p>在Spring的IoC容器中，我们把所有组件统称为JavaBean，即配置一个组件就是配置一个Bean。</p> <h3 id="依赖注入方式"><a href="#依赖注入方式" class="header-anchor">#</a> 依赖注入方式</h3> <p>我们从上面的代码可以看到，依赖注入可以通过set()方法实现。但依赖注入也可以通过构造方法实现。</p> <p>很多Java类都具有带参数的构造方法，如果我们把BookService改造为通过构造方法注入，那么实现代码如下：</p> <div class="language-xml extra-class"><pre class="language-xml"><code>public class BookService {
    private DataSource dataSource;

    public BookService(DataSource dataSource) {
        this.dataSource = dataSource;
    }
}
</code></pre></div><p>Spring的IoC容器同时支持属性注入和构造方法注入，并允许混合使用。</p> <h3 id="无侵入容器"><a href="#无侵入容器" class="header-anchor">#</a> 无侵入容器</h3> <p>在设计上，Spring的IoC容器是一个高度可扩展的无侵入容器。所谓无侵入，是指应用程序的组件无需实现Spring的特定接口，或者说，组件根本不知道自己在Spring的容器中运行。这种无侵入的设计有以下好处：</p> <p>应用程序组件既可以在Spring的IoC容器中运行，也可以自己编写代码自行组装配置；
测试的时候并不依赖Spring容器，可单独进行测试，大大提高了开发效率。</p> <h2 id="装备bean（容器中bean的装配方式-xml、annotation）"><a href="#装备bean（容器中bean的装配方式-xml、annotation）" class="header-anchor">#</a> 装备bean（容器中bean的装配方式-xml、annotation）</h2> <h3 id="容器装配-xml装配"><a href="#容器装配-xml装配" class="header-anchor">#</a> 容器装配-xml装配</h3> <div class="language-xml extra-class"><pre class="language-xml"><code>ApplicationContext context = new ClassPathXmlApplicationContext(&quot;application.xml&quot;);

// xml配置文件application.xml
<span class="token prolog">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>beans</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>http://www.springframework.org/schema/beans<span class="token punctuation">&quot;</span></span>
    <span class="token attr-name"><span class="token namespace">xmlns:</span>xsi</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>http://www.w3.org/2001/XMLSchema-instance<span class="token punctuation">&quot;</span></span>
    <span class="token attr-name"><span class="token namespace">xsi:</span>schemaLocation</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>http://www.springframework.org/schema/beans
        https://www.springframework.org/schema/beans/spring-beans.xsd<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>userService<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>com.itranswarp.learnjava.service.UserService<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>mailService<span class="token punctuation">&quot;</span></span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>mailService<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>mailService<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>com.itranswarp.learnjava.service.MailService<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>beans</span><span class="token punctuation">&gt;</span></span>

每个<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">...</span><span class="token punctuation">&gt;</span></span>都有一个id标识，相当于Bean的唯一ID；
在userServiceBean中，通过<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>...<span class="token punctuation">&quot;</span></span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>...<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>注入了另一个Bean；
Bean的顺序不重要，Spring根据依赖关系会自动正确初始化。

而是boolean、int、String这样的数据类型，则通过value注入
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>dataSource<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>com.zaxxer.hikari.HikariDataSource<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>jdbcUrl<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>jdbc:mysql://localhost:3306/test<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>username<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>root<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>password<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>password<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>maximumPoolSize<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>10<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>autoCommit<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>true<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>

</code></pre></div><h3 id="使用bean"><a href="#使用bean" class="header-anchor">#</a> 使用bean</h3> <div class="language-xml extra-class"><pre class="language-xml"><code>// 获取Bean:
UserService userService = context.getBean(UserService.class);

</code></pre></div><h3 id="spring两种容器"><a href="#spring两种容器" class="header-anchor">#</a> spring两种容器</h3> <p>Spring容器就是ApplicationContext，它是一个接口，有很多实现类，这里我们选择ClassPathXmlApplicationContext，表示它会自动从classpath中查找指定的XML配置文件。</p> <p>获得了ApplicationContext的实例，就获得了IoC容器的引用。从ApplicationContext中我们可以根据Bean的ID获取Bean，但更多的时候我们根据Bean的类型获取Bean的引用：</p> <div class="language-xml extra-class"><pre class="language-xml"><code>UserService userService = context.getBean(UserService.class);
</code></pre></div><p>Spring还提供另一种IoC容器叫BeanFactory，使用方式和ApplicationContext类似：</p> <div class="language-xml extra-class"><pre class="language-xml"><code>BeanFactory factory = new XmlBeanFactory(new ClassPathResource(&quot;application.xml&quot;));
MailService mailService = factory.getBean(MailService.class);
</code></pre></div><p>BeanFactory和ApplicationContext的区别在于，BeanFactory的实现是按需创建，即第一次获取Bean时才创建这个Bean，而ApplicationContext会一次性创建所有的Bean。
实际上，ApplicationContext接口是从BeanFactory接口继承而来的，并且，ApplicationContext提供了一些额外的功能，包括国际化支持、事件和通知机制等。
通常情况下，我们总是使用ApplicationContext，很少会考虑使用BeanFactory。</p> <h2 id="容器装配-annotation配置"><a href="#容器装配-annotation配置" class="header-anchor">#</a> 容器装配-annotation配置</h2> <p>除了使用xml装配bean，还可以使用Annotation配置，可以完全不需要XML，让Spring自动扫描Bean并组装它们。
例如</p> <div class="language-xml extra-class"><pre class="language-xml"><code>@Component
public class MailService {
    ...
}
// 这个@Component注解就相当于定义了一个Bean，它有一个可选的名称，默认是mailService，即小写开头的类名。
   
//   然后，我们给UserService添加一个@Component注解和一个@Autowired注解：
@Component
public class UserService {
    @Autowired
    MailService mailService;
    ...
}
// 使用@Autowired就相当于把指定类型的Bean注入到指定的字段中。和XML配置相比，@Autowired大幅简化了注入，因为它不但可以写在set()方法上，还可以直接写在字段上，甚至可以写在构造方法中：
@Component
public class UserService {
    MailService mailService;

    public UserService(@Autowired MailService mailService) {
        this.mailService = mailService;
    }
    ...
}

//我们一般把@Autowired写在字段上，通常使用package权限的字段，便于测试。最后，编写一个AppConfig类启动容器：
@Configuration
@ComponentScan
public class AppConfig {
    public static void main(String[] args) {
        ApplicationContext context = new AnnotationConfigApplicationContext(AppConfig.class);
        UserService userService = context.getBean(UserService.class);
        User user = userService.login(&quot;bob@example.com&quot;, &quot;password&quot;);
        System.out.println(user.getName());
    }
}

//除了main()方法外，AppConfig标注了@Configuration，表示它是一个配置类，因为我们创建ApplicationContext时：
</code></pre></div><h3 id="configuration的作用"><a href="#configuration的作用" class="header-anchor">#</a> @Configuration的作用</h3> <div class="language-xml extra-class"><pre class="language-xml"><code>ApplicationContext context = new AnnotationConfigApplicationContext(AppConfig.class);
</code></pre></div><p>使用的实现类是AnnotationConfigApplicationContext，必须传入一个标注了@Configuration的类名。</p> <p>此外，AppConfig还标注了@ComponentScan，它告诉容器，自动搜索当前类所在的包以及子包，把所有标注为@Component的Bean自动创建出来，并根据@Autowired进行装配。</p> <h2 id="bean-scope"><a href="#bean-scope" class="header-anchor">#</a> bean scope</h2> <p>容器默认的bean是单例的，若需要非单例bean，则需要用到@Scope</p> <div class="language-xml extra-class"><pre class="language-xml"><code>@Component
@Scope(ConfigurableBeanFactory.SCOPE_PROTOTYPE) // @Scope(&quot;prototype&quot;)
public class MailSession {
    ...
}
</code></pre></div><h3 id="list注入"><a href="#list注入" class="header-anchor">#</a> list注入</h3> <div class="language-xml extra-class"><pre class="language-xml"><code>注入List
有些时候，我们会有一系列接口相同，不同实现类的Bean。例如，注册用户时，我们要对email、password和name这3个变量进行验证。为了便于扩展，我们先定义验证接口：

public interface Validator {
    void validate(String email, String password, String name);
}
然后，分别使用3个Validator对用户参数进行验证：

@Component
public class EmailValidator implements Validator {
    public void validate(String email, String password, String name) {
        if (!email.matches(&quot;^[a-z0-9]+\\@[a-z0-9]+\\.[a-z]{2,10}$&quot;)) {
            throw new IllegalArgumentException(&quot;invalid email: &quot; + email);
        }
    }
}

@Component
public class PasswordValidator implements Validator {
    public void validate(String email, String password, String name) {
        if (!password.matches(&quot;^.{6,20}$&quot;)) {
            throw new IllegalArgumentException(&quot;invalid password&quot;);
        }
    }
}

@Component
public class NameValidator implements Validator {
    public void validate(String email, String password, String name) {
        if (name == null || name.isBlank() || name.length() &gt; 20) {
            throw new IllegalArgumentException(&quot;invalid name: &quot; + name);
        }
    }
}
最后，我们通过一个Validators作为入口进行验证：

@Component
public class Validators {
    @Autowired
    List<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Validator</span><span class="token punctuation">&gt;</span></span> validators;

    public void validate(String email, String password, String name) {
        for (var validator : this.validators) {
            validator.validate(email, password, name);
        }
    }
}
注意到Validators被注入了一个List<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Validator</span><span class="token punctuation">&gt;</span></span>，Spring会自动把所有类型为Validator的Bean装配为一个List注入进来，这样一来，我们每新增一个Validator类型，就自动被Spring装配到Validators中了，非常方便。

因为Spring是通过扫描classpath获取到所有的Bean，而List是有序的，要指定List中Bean的顺序，可以加上@Order注解：

@Component
@Order(1)
public class EmailValidator implements Validator {
    ...
}

@Component
@Order(2)
public class PasswordValidator implements Validator {
    ...
}

@Component
@Order(3)
public class NameValidator implements Validator {
    ...
}
</code></pre></div><h3 id="可选注入"><a href="#可选注入" class="header-anchor">#</a> 可选注入</h3> <div class="language-xml extra-class"><pre class="language-xml"><code>默认情况下，当我们标记了一个@Autowired后，Spring如果没有找到对应类型的Bean，它会抛出NoSuchBeanDefinitionException异常。
    
可以给@Autowired增加一个required = false的参数：

@Component
public class MailService {
    @Autowired(required = false)
    ZoneId zoneId = ZoneId.systemDefault();
    ...
}
这个参数告诉Spring容器，如果找到一个类型为ZoneId的Bean，就注入，如果找不到，就忽略。

这种方式非常适合有定义就使用定义，没有就使用默认值的情况。
</code></pre></div><h3 id="创建第三方bean"><a href="#创建第三方bean" class="header-anchor">#</a> 创建第三方Bean</h3> <div class="language-xml extra-class"><pre class="language-xml"><code>如果一个Bean不在我们自己的package管理之类，例如ZoneId，如何创建它？
    
    答案是我们自己在@Configuration类中编写一个Java方法创建并返回它，注意给方法标记一个@Bean注解：
    
    @Configuration
    @ComponentScan
    public class AppConfig {
        // 创建一个Bean:
        @Bean
        ZoneId createZoneId() {
            return ZoneId.of(&quot;Z&quot;);
        }
    }
    Spring对标记为@Bean的方法只调用一次，因此返回的Bean仍然是单例。
</code></pre></div><h3 id="初始化和销毁"><a href="#初始化和销毁" class="header-anchor">#</a> 初始化和销毁</h3> <div class="language-xml extra-class"><pre class="language-xml"><code>
有些时候，一个Bean在注入必要的依赖后，需要进行初始化（监听消息等）。在容器关闭时，有时候还需要清理资源（关闭连接池等）。我们通常会定义一个init()方法进行初始化，定义一个shutdown()方法进行清理，然后，引入JSR-250定义的Annotation：

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>javax.annotation<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>javax.annotation-api<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.3.2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
在Bean的初始化和清理方法上标记@PostConstruct和@PreDestroy：

@Component
public class MailService {
    @Autowired(required = false)
    ZoneId zoneId = ZoneId.systemDefault();

    @PostConstruct
    public void init() {
        System.out.println(&quot;Init mail service with zoneId = &quot; + this.zoneId);
    }

    @PreDestroy
    public void shutdown() {
        System.out.println(&quot;Shutdown mail service&quot;);
    }
}
Spring容器会对上述Bean做如下初始化流程：

调用构造方法创建MailService实例；
根据@Autowired进行注入；
调用标记有@PostConstruct的init()方法进行初始化。
而销毁时，容器会首先调用标记有@PreDestroy的shutdown()方法。

Spring只根据Annotation查找无参数方法，对方法名不作要求。
</code></pre></div><h3 id="使用别名"><a href="#使用别名" class="header-anchor">#</a> 使用别名</h3> <div class="language-xml extra-class"><pre class="language-xml"><code>
默认情况下，对一种类型的Bean，容器只创建一个实例。但有些时候，我们需要对一种类型的Bean创建多个实例。例如，同时连接多个数据库，就必须创建多个DataSource实例。

如果我们在@Configuration类中创建了多个同类型的Bean：

@Configuration
@ComponentScan
public class AppConfig {
    @Bean
    ZoneId createZoneOfZ() {
        return ZoneId.of(&quot;Z&quot;);
    }

    @Bean
    ZoneId createZoneOfUTC8() {
        return ZoneId.of(&quot;UTC+08:00&quot;);
    }
}
Spring会报NoUniqueBeanDefinitionException异常，意思是出现了重复的Bean定义。

这个时候，需要给每个Bean添加不同的名字：

@Configuration
@ComponentScan
public class AppConfig {
    @Bean(&quot;z&quot;)
    ZoneId createZoneOfZ() {
        return ZoneId.of(&quot;Z&quot;);
    }

    @Bean
    @Qualifier(&quot;utc8&quot;)
    ZoneId createZoneOfUTC8() {
        return ZoneId.of(&quot;UTC+08:00&quot;);
    }
}
可以用@Bean(&quot;name&quot;)指定别名，也可以用@Bean+@Qualifier(&quot;name&quot;)指定别名。

存在多个同类型的Bean时，注入ZoneId又会报错：

NoUniqueBeanDefinitionException: No qualifying bean of type 'java.time.ZoneId' available: expected single matching bean but found 2
意思是期待找到唯一的ZoneId类型Bean，但是找到两。因此，注入时，要指定Bean的名称：

@Component
public class MailService {
	@Autowired(required = false)
	@Qualifier(&quot;z&quot;) // 指定注入名称为&quot;z&quot;的ZoneId
	ZoneId zoneId = ZoneId.systemDefault();
    ...
}
还有一种方法是把其中某个Bean指定为@Primary：

@Configuration
@ComponentScan
public class AppConfig {
    @Bean
    @Primary // 指定为主要Bean
    @Qualifier(&quot;z&quot;)
    ZoneId createZoneOfZ() {
        return ZoneId.of(&quot;Z&quot;);
    }

    @Bean
    @Qualifier(&quot;utc8&quot;)
    ZoneId createZoneOfUTC8() {
        return ZoneId.of(&quot;UTC+08:00&quot;);
    }
}
这样，在注入时，如果没有指出Bean的名字，Spring会注入标记有@Primary的Bean。这种方式也很常用。例如，对于主从两个数据源，通常将主数据源定义为@Primary：

@Configuration
@ComponentScan
public class AppConfig {
    @Bean
    @Primary
    DataSource createMasterDataSource() {
        ...
    }

    @Bean
    @Qualifier(&quot;slave&quot;)
    DataSource createSlaveDataSource() {
        ...
    }
}
其他Bean默认注入的就是主数据源。如果要注入从数据源，那么只需要指定名称即可。
</code></pre></div><h3 id="使用factorybean"><a href="#使用factorybean" class="header-anchor">#</a> 使用FactoryBean</h3> <div class="language-xml extra-class"><pre class="language-xml"><code>
我们在设计模式的工厂方法中讲到，很多时候，可以通过工厂模式创建对象。Spring也提供了工厂模式，允许定义一个工厂，然后由工厂创建真正的Bean。

用工厂模式创建Bean需要实现FactoryBean接口。我们观察下面的代码：

@Component
public class ZoneIdFactoryBean implements FactoryBean<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ZoneId</span><span class="token punctuation">&gt;</span></span> {

    String zone = &quot;Z&quot;;

    @Override
    public ZoneId getObject() throws Exception {
        return ZoneId.of(zone);
    }

    @Override
    public Class<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>?</span><span class="token punctuation">&gt;</span></span> getObjectType() {
        return ZoneId.class;
    }
}
当一个Bean实现了FactoryBean接口后，Spring会先实例化这个工厂，然后调用getObject()创建真正的Bean。getObjectType()可以指定创建的Bean的类型，因为指定类型不一定与实际类型一致，可以是接口或抽象类。

因此，如果定义了一个FactoryBean，要注意Spring创建的Bean实际上是这个FactoryBean的getObject()方法返回的Bean。为了和普通Bean区分，我们通常都以XxxFactoryBean命名。
</code></pre></div><h2 id="resource-封装了读取配置文件或加载资源文件"><a href="#resource-封装了读取配置文件或加载资源文件" class="header-anchor">#</a> Resource - 封装了读取配置文件或加载资源文件</h2> <p>在Java程序中，我们经常会读取配置文件、资源文件等。使用Spring容器时，我们也可以把“文件”注入进来，方便程序读取。</p> <p>例如，AppService需要读取logo.txt这个文件，通常情况下，我们需要写很多繁琐的代码，主要是为了定位文件，打开InputStream。</p> <p>Spring提供了一个org.springframework.core.io.Resource（注意不是javax.annotation.Resource），它可以像String、int一样使用@Value注入：</p> <div class="language-xml extra-class"><pre class="language-xml"><code>@Component
public class AppService {
    @Value(&quot;classpath:/logo.txt&quot;)
    private Resource resource;

    private String logo;

    @PostConstruct
    public void init() throws IOException {
        try (var reader = new BufferedReader(
                new InputStreamReader(resource.getInputStream(), StandardCharsets.UTF_8))) {
            this.logo = reader.lines().collect(Collectors.joining(&quot;\n&quot;));
        }
    }
}
</code></pre></div><p>注入Resource最常用的方式是通过classpath，即类似classpath:/logo.txt表示在classpath中搜索logo.txt文件，然后，我们直接调用Resource.getInputStream()就可以获取到输入流，避免了自己搜索文件的代码。</p> <p>也可以直接指定文件的路径，例如：</p> <div class="language-xml extra-class"><pre class="language-xml"><code>@Value(&quot;file:/path/to/logo.txt&quot;)
private Resource resource;
</code></pre></div><h2 id="配置注入"><a href="#配置注入" class="header-anchor">#</a> 配置注入</h2> <p>在开发应用程序时，经常需要读取配置文件。最常用的配置方法是以key=value的形式写在.properties文件中。</p> <p>例如，MailService根据配置的app.zone=Asia/Shanghai来决定使用哪个时区。要读取配置文件，我们可以使用上一节讲到的Resource来读取位于classpath下的一个app.properties文件。但是，这样仍然比较繁琐。</p> <p>Spring容器还提供了一个更简单的@PropertySource来自动读取配置文件。我们只需要在@Configuration配置类上再添加一个注解：</p> <div class="language-xml extra-class"><pre class="language-xml"><code>@Configuration
@ComponentScan
@PropertySource(&quot;app.properties&quot;) // 表示读取classpath的app.properties
public class AppConfig {
    @Value(&quot;${app.zone:Z}&quot;)
    String zoneId;

    @Bean
    ZoneId createZoneId() {
        return ZoneId.of(zoneId);
    }
}
Spring容器看到@PropertySource(&quot;app.properties&quot;)注解后，自动读取这个配置文件，然后，我们使用@Value正常注入：

@Value(&quot;${app.zone:Z}&quot;)
String zoneId;
注意注入的字符串语法，它的格式如下：

&quot;${app.zone}&quot;表示读取key为app.zone的value，如果key不存在，启动将报错；
&quot;${app.zone:Z}&quot;表示读取key为app.zone的value，但如果key不存在，就使用默认值Z。
这样一来，我们就可以根据app.zone的配置来创建ZoneId。

还可以把注入的注解写到方法参数中：

@Bean
ZoneId createZoneId(@Value(&quot;${app.zone:Z}&quot;) String zoneId) {
    return ZoneId.of(zoneId);
}
</code></pre></div><p>可见，先使用@PropertySource读取配置文件，然后通过@Value以${key:defaultValue}的形式注入，可以极大地简化读取配置的麻烦。</p> <p>另一种注入配置的方式是先通过一个简单的JavaBean持有所有的配置，例如，一个SmtpConfig：</p> <div class="language-xml extra-class"><pre class="language-xml"><code>@Component
public class SmtpConfig {
    @Value(&quot;${smtp.host}&quot;)
    private String host;

    @Value(&quot;${smtp.port:25}&quot;)
    private int port;

    public String getHost() {
        return host;
    }

    public int getPort() {
        return port;
    }
}
然后，在需要读取的地方，使用#{smtpConfig.host}注入：

@Component
public class MailService {
    @Value(&quot;#{smtpConfig.host}&quot;)
    private String smtpHost;

    @Value(&quot;#{smtpConfig.port}&quot;)
    private int smtpPort;
}
</code></pre></div><p>注意观察#{}这种注入语法，它和${key}不同的是，#{}表示从JavaBean读取属性。&quot;#{smtpConfig.host}&quot;的意思是，从名称为smtpConfig的Bean读取host属性，即调用getHost()方法。一个Class名为SmtpConfig的Bean，它在Spring容器中的默认名称就是smtpConfig，除非用@Qualifier指定了名称。</p> <p>使用一个独立的JavaBean持有所有属性，然后在其他Bean中以#{bean.property}注入的好处是，多个Bean都可以引用同一个Bean的某个属性。例如，如果SmtpConfig决定从数据库中读取相关配置项，那么MailService注入的@Value(&quot;#{smtpConfig.host}&quot;)仍然可以不修改正常运行。</p> <h2 id="条件装配（springboot灵魂）"><a href="#条件装配（springboot灵魂）" class="header-anchor">#</a> 条件装配（springboot灵魂）</h2> <h3 id="profile"><a href="#profile" class="header-anchor">#</a> profile</h3> <div class="language-xml extra-class"><pre class="language-xml"><code>开发应用程序时，我们会使用开发环境，例如，使用内存数据库以便快速启动。而运行在生产环境时，我们会使用生产环境，例如，使用MySQL数据库。如果应用程序可以根据自身的环境做一些适配，无疑会更加灵活。

Spring为应用程序准备了Profile这一概念，用来表示不同的环境。例如，我们分别定义开发、测试和生产这3个环境：

native
test
production
创建某个Bean时，Spring容器可以根据注解@Profile来决定是否创建。例如，以下配置：

@Configuration
@ComponentScan
public class AppConfig {
    @Bean
    @Profile(&quot;!test&quot;)
    ZoneId createZoneId() {
        return ZoneId.systemDefault();
    }

    @Bean
    @Profile(&quot;test&quot;)
    ZoneId createZoneIdForTest() {
        return ZoneId.of(&quot;America/New_York&quot;);
    }
}
如果当前的Profile设置为test，则Spring容器会调用createZoneIdForTest()创建ZoneId，否则，调用createZoneId()创建ZoneId。注意到@Profile(&quot;!test&quot;)表示非test环境。

在运行程序时，加上JVM参数-Dspring.profiles.active=test就可以指定以test环境启动。

实际上，Spring允许指定多个Profile，例如：

-Dspring.profiles.active=test,master
可以表示test环境，并使用master分支代码。

要满足多个Profile条件，可以这样写：

@Bean
@Profile({ &quot;test&quot;, &quot;master&quot; }) // 同时满足test和master
ZoneId createZoneId() {
    ...
}
</code></pre></div><h3 id="conditional"><a href="#conditional" class="header-anchor">#</a> Conditional</h3> <p>除了根据@Profile条件来决定是否创建某个Bean外，Spring还可以根据@Conditional决定是否创建某个Bean。</p> <p>例如，我们对SmtpMailService添加如下注解：</p> <div class="language- extra-class"><pre class="language-text"><code>@Component
@Conditional(OnSmtpEnvCondition.class)
public class SmtpMailService implements MailService {
    ...
}
</code></pre></div><p>它的意思是，如果满足OnSmtpEnvCondition的条件，才会创建SmtpMailService这个Bean。OnSmtpEnvCondition的条件是什么呢？我们看一下代码：</p> <div class="language- extra-class"><pre class="language-text"><code>public class OnSmtpEnvCondition implements Condition {
    public boolean matches(ConditionContext context, AnnotatedTypeMetadata metadata) {
        return &quot;true&quot;.equalsIgnoreCase(System.getenv(&quot;smtp&quot;));
    }
}
</code></pre></div><p>因此，OnSmtpEnvCondition的条件是存在环境变量smtp，值为true。这样，我们就可以通过环境变量来控制是否创建SmtpMailService。</p> <p>Spring只提供了@Conditional注解，具体判断逻辑还需要我们自己实现。Spring Boot提供了更多使用起来更简单的条件注解，例如，如果配置文件中存在app.smtp=true，则创建MailService：</p> <div class="language- extra-class"><pre class="language-text"><code>@Component
@ConditionalOnProperty(name=&quot;app.smtp&quot;, havingValue=&quot;true&quot;)
public class MailService {
    ...
}
</code></pre></div><p>如果当前classpath中存在类javax.mail.Transport，则创建MailService：</p> <div class="language- extra-class"><pre class="language-text"><code>@Component
@ConditionalOnClass(name = &quot;javax.mail.Transport&quot;)
public class MailService {
    ...
}
</code></pre></div><p>后续我们会介绍Spring Boot的条件装配。我们以文件存储为例，假设我们需要保存用户上传的头像，并返回存储路径，在本地开发运行时，我们总是存储到文件：</p> <div class="language- extra-class"><pre class="language-text"><code>@Component
@ConditionalOnProperty(name = &quot;app.storage&quot;, havingValue = &quot;file&quot;, matchIfMissing = true)
public class FileUploader implements Uploader {
    ...
}
</code></pre></div><p>在生产环境运行时，我们会把文件存储到类似AWS S3上：</p> <div class="language- extra-class"><pre class="language-text"><code>@Component
@ConditionalOnProperty(name = &quot;app.storage&quot;, havingValue = &quot;s3&quot;)
public class S3Uploader implements Uploader {
    ...
}
</code></pre></div><p>其他需要存储的服务则注入Uploader：</p> <div class="language- extra-class"><pre class="language-text"><code>@Component
public class UserImageService {
    @Autowired
    Uploader uploader;
}
</code></pre></div><p>当应用程序检测到配置文件存在app.storage=s3时，自动使用S3Uploader，如果存在配置app.storage=file，或者配置app.storage不存在，则使用FileUploader。</p> <p>可见，使用条件注解，能更灵活地装配Bean。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><!----> <span class="next"><a href="/onedocs/Spring/" class="router-link-active">
        首页
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/onedocs/assets/js/app.11121a75.js" defer></script><script src="/onedocs/assets/js/2.2038ef08.js" defer></script><script src="/onedocs/assets/js/27.8aa415f6.js" defer></script>
  </body>
</html>
